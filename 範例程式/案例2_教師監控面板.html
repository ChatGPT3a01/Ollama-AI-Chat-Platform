<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師監控面板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .student-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            transition: box-shadow 0.3s;
        }

        .student-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .student-card .info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .student-card .info-item {
            background: white;
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .student-card .info-item strong {
            color: #667eea;
        }

        .topic-chart {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .topic-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .topic-badge.high {
            background: #ffcdd2;
            color: #c62828;
        }

        .topic-badge.medium {
            background: #fff9c4;
            color: #f9a825;
        }

        .topic-badge.low {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }

        .refresh-time {
            text-align: right;
            color: #999;
            font-size: 0.85em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>教師監控面板</h1>
        <p class="subtitle">查看學生的學習概況與分析</p>

        <div class="refresh-time" id="refresh-time"></div>

        <div class="stats-overview" id="stats-overview">
            <!-- 統計卡片將由 JavaScript 生成 -->
        </div>

        <div class="section">
            <h2>學生學習概況</h2>
            <button class="btn" onclick="generateTeacherReport()">重新載入</button>
            <button class="btn btn-danger" onclick="clearAllData()">清除所有資料</button>
            <div id="student-stats"></div>
        </div>

        <div class="section">
            <h2>主題分析</h2>
            <div id="topic-analysis"></div>
        </div>
    </div>

    <script>
    // 分析學習弱點
    function analyzeWeakPoints(studentId) {
        const history = JSON.parse(localStorage.getItem(`student_${studentId}`) || '[]');
        const topicCount = {};
        history.forEach(record => {
            topicCount[record.topic] = (topicCount[record.topic] || 0) + 1;
        });
        return Object.entries(topicCount).sort((a, b) => b[1] - a[1]);
    }

    // 取得所有學生 ID
    function getAllStudents() {
        const students = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('student_')) {
                students.push(key.replace('student_', ''));
            }
        }
        return students;
    }

    // 產生報表
    function generateTeacherReport() {
        const students = getAllStudents();
        const statsContainer = document.getElementById('stats-overview');
        const studentStatsContainer = document.getElementById('student-stats');
        const topicAnalysisContainer = document.getElementById('topic-analysis');

        // 更新時間
        document.getElementById('refresh-time').textContent =
            `最後更新：${new Date().toLocaleString('zh-TW')}`;

        if (students.length === 0) {
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="number">0</div>
                    <div class="label">總學生數</div>
                </div>
                <div class="stat-card">
                    <div class="number">0</div>
                    <div class="label">總提問數</div>
                </div>
            `;
            studentStatsContainer.innerHTML = '<div class="no-data">尚無學生資料。請先讓學生使用「蘇格拉底式教學助手」進行學習。</div>';
            topicAnalysisContainer.innerHTML = '<div class="no-data">尚無主題資料</div>';
            return;
        }

        // 計算總統計
        let totalQuestions = 0;
        let allTopics = {};

        students.forEach(studentId => {
            const history = JSON.parse(localStorage.getItem(`student_${studentId}`) || '[]');
            totalQuestions += history.length;
            history.forEach(record => {
                allTopics[record.topic] = (allTopics[record.topic] || 0) + 1;
            });
        });

        // 顯示總統計
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="number">${students.length}</div>
                <div class="label">總學生數</div>
            </div>
            <div class="stat-card">
                <div class="number">${totalQuestions}</div>
                <div class="label">總提問數</div>
            </div>
            <div class="stat-card">
                <div class="number">${(totalQuestions / students.length).toFixed(1)}</div>
                <div class="label">平均提問數</div>
            </div>
            <div class="stat-card">
                <div class="number">${Object.keys(allTopics).length}</div>
                <div class="label">涵蓋主題數</div>
            </div>
        `;

        // 顯示每位學生的資料
        let studentReport = '';
        students.forEach(studentId => {
            const history = JSON.parse(localStorage.getItem(`student_${studentId}`) || '[]');
            const weakPoints = analyzeWeakPoints(studentId);
            const total = weakPoints.reduce((sum, [_, count]) => sum + count, 0);

            let topicsHtml = '';
            weakPoints.forEach(([topic, count], index) => {
                let badgeClass = 'low';
                if (index === 0 && count > 3) badgeClass = 'high';
                else if (count > 2) badgeClass = 'medium';
                topicsHtml += `<span class="topic-badge ${badgeClass}">${topic}: ${count}次</span>`;
            });

            const lastActivity = history.length > 0
                ? new Date(history[history.length - 1].timestamp).toLocaleString('zh-TW')
                : '無記錄';

            studentReport += `
                <div class="student-card">
                    <h3>${studentId}</h3>
                    <div class="info">
                        <div class="info-item">
                            <strong>總提問次數：</strong>${total}
                        </div>
                        <div class="info-item">
                            <strong>主要困難：</strong>${weakPoints[0]?.[0] || '尚無資料'}
                        </div>
                        <div class="info-item">
                            <strong>最後活動：</strong>${lastActivity}
                        </div>
                    </div>
                    <div class="topic-chart">
                        ${topicsHtml || '<span style="color:#999">尚無主題資料</span>'}
                    </div>
                </div>
            `;
        });

        studentStatsContainer.innerHTML = studentReport || '<div class="no-data">尚無學生資料</div>';

        // 主題分析
        const sortedTopics = Object.entries(allTopics).sort((a, b) => b[1] - a[1]);
        let topicHtml = '<div style="display: flex; gap: 10px; flex-wrap: wrap;">';
        sortedTopics.forEach(([topic, count]) => {
            const percentage = ((count / totalQuestions) * 100).toFixed(1);
            topicHtml += `
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${count}</div>
                    <div style="color: #666;">${topic}</div>
                    <div style="font-size: 0.8em; color: #999;">${percentage}%</div>
                </div>
            `;
        });
        topicHtml += '</div>';
        topicAnalysisContainer.innerHTML = topicHtml || '<div class="no-data">尚無主題資料</div>';
    }

    // 清除所有資料
    function clearAllData() {
        if (confirm('確定要清除所有學生資料嗎？此操作無法復原！')) {
            const students = getAllStudents();
            students.forEach(studentId => {
                localStorage.removeItem(`student_${studentId}`);
            });
            generateTeacherReport();
            alert('已清除所有資料');
        }
    }

    // 頁面載入時產生報表
    generateTeacherReport();
    </script>
</body>
</html>
