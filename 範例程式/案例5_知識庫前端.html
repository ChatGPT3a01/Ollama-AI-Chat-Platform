<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的第二大腦 - 個人知識庫</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #eee;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
        }
        .section {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .section h2 {
            margin-bottom: 15px;
            color: #4fc3f7;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        textarea { height: 150px; resize: vertical; }
        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #4fc3f7 0%, #0097a7 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background: #666; cursor: not-allowed; }
        button.danger {
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
        }
        #answer-result {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            line-height: 1.8;
        }
        #answer-result h3 { color: #4fc3f7; margin-bottom: 10px; }
        .sources { color: #aaa; font-size: 0.9em; margin-top: 15px; }
        .sources span { background: #333; padding: 3px 8px; border-radius: 4px; margin-right: 5px; }
        .note-list { margin-top: 15px; }
        .note-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }
        .note-item strong { color: #4fc3f7; display: block; margin-bottom: 5px; }
        .note-item .tags { margin-top: 8px; }
        .note-item .tags span {
            background: #0097a7;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
        }
        .note-item .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #c62828;
            padding: 5px 10px;
            font-size: 12px;
        }
        .loading { color: #4fc3f7; font-style: italic; }
        .status { padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; }
        .status.success { background: rgba(76, 175, 80, 0.3); }
        .status.error { background: rgba(244, 67, 54, 0.3); }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            background: rgba(79, 195, 247, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card .number { font-size: 2em; font-weight: bold; color: #4fc3f7; }
        .stat-card .label { color: #aaa; font-size: 0.9em; }

        .model-select {
            margin-bottom: 15px;
        }
        .model-select label { margin-right: 10px; }
        .model-select select {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>我的第二大腦</h1>
        <p class="subtitle">個人知識庫 - 所有資料完全在本機處理</p>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="note-count">0</div>
                <div class="label">筆記數量</div>
            </div>
            <div class="stat-card">
                <div class="number" id="query-count">0</div>
                <div class="label">查詢次數</div>
            </div>
        </div>

        <!-- 問答區 -->
        <div class="section">
            <h2>詢問知識庫</h2>
            <div class="model-select">
                <label>模型：</label>
                <select id="model-select">
                    <option value="llama3">Llama 3 (8B)</option>
                    <option value="mistral">Mistral (7B)</option>
                </select>
            </div>
            <input type="text" id="question" placeholder="問任何問題，AI 會從你的筆記中找答案...">
            <button onclick="askQuestion()">搜尋答案</button>
            <div id="answer-result"></div>
        </div>

        <!-- 新增筆記 -->
        <div class="section">
            <h2>新增筆記</h2>
            <input type="text" id="note-title" placeholder="標題（例如：Python 學習筆記）">
            <textarea id="note-content" placeholder="筆記內容..."></textarea>
            <input type="text" id="note-tags" placeholder="標籤（用逗號分隔，例如：程式設計, Python）">
            <button onclick="addNote()">儲存筆記</button>
            <div id="add-status"></div>
        </div>

        <!-- 筆記列表 -->
        <div class="section">
            <h2>已儲存的筆記</h2>
            <input type="text" id="search-notes" placeholder="搜尋筆記..." oninput="filterNotes()">
            <button onclick="loadNotes()">重新載入</button>
            <button class="danger" onclick="clearAllNotes()">清除所有筆記</button>
            <div id="note-list" class="note-list">載入中...</div>
        </div>
    </div>

    <script>
    const OLLAMA_API = 'http://localhost:11434/api/generate';
    let queryCount = parseInt(localStorage.getItem('queryCount') || '0');

    // 更新統計
    function updateStats() {
        const notes = JSON.parse(localStorage.getItem('knowledge_notes') || '[]');
        document.getElementById('note-count').textContent = notes.length;
        document.getElementById('query-count').textContent = queryCount;
    }

    // 詢問知識庫
    async function askQuestion() {
        const question = document.getElementById('question').value;
        const resultDiv = document.getElementById('answer-result');
        const model = document.getElementById('model-select').value;

        if (!question.trim()) {
            resultDiv.innerHTML = '<p>請輸入問題</p>';
            return;
        }

        resultDiv.innerHTML = '<p class="loading">AI 正在思考中...</p>';

        // 從 localStorage 取得筆記
        const notes = JSON.parse(localStorage.getItem('knowledge_notes') || '[]');

        if (notes.length === 0) {
            resultDiv.innerHTML = '<p>知識庫中還沒有筆記，請先新增一些筆記。</p>';
            return;
        }

        // 簡單的關鍵字搜尋找出相關筆記
        const keywords = question.toLowerCase().split(/\s+/);
        const relevantNotes = notes.filter(note => {
            const content = (note.title + ' ' + note.content + ' ' + note.tags).toLowerCase();
            return keywords.some(kw => content.includes(kw));
        }).slice(0, 3);

        const context = relevantNotes.length > 0
            ? relevantNotes.map(n => `【${n.title}】\n${n.content}`).join('\n\n---\n\n')
            : notes.slice(0, 3).map(n => `【${n.title}】\n${n.content}`).join('\n\n---\n\n');

        const sources = relevantNotes.length > 0
            ? relevantNotes.map(n => n.title)
            : notes.slice(0, 3).map(n => n.title);

        try {
            const response = await fetch(OLLAMA_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: model,
                    prompt: `基於以下我的筆記內容，回答問題。如果筆記中沒有相關資訊，請誠實說「筆記中沒有相關內容」。

我的筆記：
${context}

問題：${question}

請用繁體中文回答：`,
                    stream: false
                })
            });

            const data = await response.json();

            let sourcesHtml = '';
            if (sources.length > 0) {
                sourcesHtml = `<div class="sources">來源筆記：${sources.map(s => `<span>${s}</span>`).join('')}</div>`;
            }

            resultDiv.innerHTML = `
                <h3>答案</h3>
                <p>${data.response.replace(/\n/g, '<br>')}</p>
                ${sourcesHtml}
            `;

            // 更新查詢次數
            queryCount++;
            localStorage.setItem('queryCount', queryCount.toString());
            updateStats();

        } catch (err) {
            resultDiv.innerHTML = `<p>錯誤：${err.message}<br>請確認 Ollama 已啟動</p>`;
        }
    }

    // 新增筆記
    function addNote() {
        const title = document.getElementById('note-title').value || '未命名';
        const content = document.getElementById('note-content').value;
        const tags = document.getElementById('note-tags').value;
        const statusDiv = document.getElementById('add-status');

        if (!content.trim()) {
            statusDiv.innerHTML = '<div class="status error">請輸入筆記內容</div>';
            return;
        }

        const notes = JSON.parse(localStorage.getItem('knowledge_notes') || '[]');
        notes.push({
            id: Date.now(),
            title: title,
            content: content,
            tags: tags,
            createdAt: new Date().toISOString()
        });
        localStorage.setItem('knowledge_notes', JSON.stringify(notes));

        statusDiv.innerHTML = `<div class="status success">已儲存筆記：${title}</div>`;

        // 清空輸入欄位
        document.getElementById('note-title').value = '';
        document.getElementById('note-content').value = '';
        document.getElementById('note-tags').value = '';

        // 重新載入筆記列表
        loadNotes();
        updateStats();
    }

    // 刪除筆記
    function deleteNote(id) {
        if (!confirm('確定要刪除這則筆記嗎？')) return;

        const notes = JSON.parse(localStorage.getItem('knowledge_notes') || '[]');
        const filteredNotes = notes.filter(n => n.id !== id);
        localStorage.setItem('knowledge_notes', JSON.stringify(filteredNotes));
        loadNotes();
        updateStats();
    }

    // 清除所有筆記
    function clearAllNotes() {
        if (!confirm('確定要清除所有筆記嗎？此操作無法復原！')) return;
        localStorage.removeItem('knowledge_notes');
        loadNotes();
        updateStats();
    }

    // 載入筆記列表
    function loadNotes() {
        const listDiv = document.getElementById('note-list');
        const notes = JSON.parse(localStorage.getItem('knowledge_notes') || '[]');

        if (notes.length === 0) {
            listDiv.innerHTML = '<p style="color:#aaa; text-align:center; padding:20px;">還沒有筆記，請先新增一些！</p>';
            return;
        }

        listDiv.innerHTML = notes.map(note => {
            const tagsHtml = note.tags
                ? `<div class="tags">${note.tags.split(',').map(t => `<span>${t.trim()}</span>`).join('')}</div>`
                : '';
            const preview = note.content.length > 150 ? note.content.substring(0, 150) + '...' : note.content;

            return `
                <div class="note-item">
                    <button class="delete-btn" onclick="deleteNote(${note.id})">刪除</button>
                    <strong>${note.title}</strong>
                    <p>${preview}</p>
                    ${tagsHtml}
                </div>
            `;
        }).join('');
    }

    // 搜尋筆記
    function filterNotes() {
        const searchTerm = document.getElementById('search-notes').value.toLowerCase();
        const notes = JSON.parse(localStorage.getItem('knowledge_notes') || '[]');
        const listDiv = document.getElementById('note-list');

        const filtered = notes.filter(note => {
            const content = (note.title + ' ' + note.content + ' ' + note.tags).toLowerCase();
            return content.includes(searchTerm);
        });

        if (filtered.length === 0) {
            listDiv.innerHTML = '<p style="color:#aaa; text-align:center; padding:20px;">沒有找到符合的筆記</p>';
            return;
        }

        listDiv.innerHTML = filtered.map(note => {
            const tagsHtml = note.tags
                ? `<div class="tags">${note.tags.split(',').map(t => `<span>${t.trim()}</span>`).join('')}</div>`
                : '';
            const preview = note.content.length > 150 ? note.content.substring(0, 150) + '...' : note.content;

            return `
                <div class="note-item">
                    <button class="delete-btn" onclick="deleteNote(${note.id})">刪除</button>
                    <strong>${note.title}</strong>
                    <p>${preview}</p>
                    ${tagsHtml}
                </div>
            `;
        }).join('');
    }

    // 頁面載入時
    loadNotes();
    updateStats();

    // Enter 鍵送出問題
    document.getElementById('question').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') askQuestion();
    });
    </script>
</body>
</html>
